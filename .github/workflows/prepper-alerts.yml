name: Prepper Alerts

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

concurrency:
  group: prepper-alerts
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      NWS_USER_AGENT: ${{ secrets.NWS_USER_AGENT }}
      GMAIL_USER: ${{ secrets.GMAIL_USER }}
      GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      ALERT_EMAIL_TO: ${{ secrets.ALERT_EMAIL_TO }}
      PUSHOVER_USER_KEY: ${{ secrets.PUSHOVER_USER_KEY }}
      PUSHOVER_APP_TOKEN: ${{ secrets.PUSHOVER_APP_TOKEN }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      LLM_CLASSIFY_NEWS: '1'
      LLM_MAX_ITEMS: '6'
      LLM_MAX_CHARS: '1000'
      LLM_EMIT_ALERTS: '1'
      LLM_MIN_SEVERITY: '3'
      LLM_CONFIRM_MIN_SEVERITY: '2'
      NEWS_REQUIRE_HAZARD: ${{ vars.NEWS_REQUIRE_HAZARD || '0' }}
      NEWS_REQUIRE_HAZARD: '0'
    steps:
      - name: Validate required secrets
        run: |
          set -euo pipefail
          required=(OPENAI_API_KEY NWS_USER_AGENT GMAIL_USER GMAIL_APP_PASSWORD ALERT_EMAIL_TO PUSHOVER_USER_KEY PUSHOVER_APP_TOKEN)
          missing=0
          for var in "${required[@]}"; do
            if [ -z "${!var:-}" ]; then
              echo "::error::Missing required secret: $var"
              missing=1
            fi
          done
          if [ "$missing" -eq 1 ]; then
            exit 1
          fi
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: pip install --upgrade pip && pip install -r requirements.txt
      - name: Validate configs
        run: python -m scripts.validate
      - name: Rebuild keywords
        run: python -m scripts.cli rebuild-keywords
      - name: Run orchestrator
        run: python -m scripts.prepper_alerts
      - name: Ensure snapshot file exists
        if: always()
        run: |
          mkdir -p data
          if [ ! -f data/latest_run.json ]; then
            echo '{"run_id":"none","locations":{}}' > data/latest_run.json
          fi
      - name: Persist run artifacts
        run: |
          set -euo pipefail
          if [[ -n "$(git status --porcelain data config/keywords.yaml)" ]]; then
            if [[ -z "${{ secrets.GH_PUSH_TOKEN }}" ]]; then
              echo "GH_PUSH_TOKEN not set; skipping automatic commit/push."
              exit 0
            fi
            BOT_NAME="${{ secrets.GH_BOT_NAME }}"
            BOT_EMAIL="${{ secrets.GH_BOT_EMAIL }}"
            if [[ -z "$BOT_NAME" ]]; then BOT_NAME="github-actions"; fi
            if [[ -z "$BOT_EMAIL" ]]; then BOT_EMAIL="actions@github.com"; fi
            git config user.name "$BOT_NAME"
            git config user.email "$BOT_EMAIL"
            git add data config/keywords.yaml
            git commit -m "chore: persist alert artifacts"
            git remote set-url origin https://x-access-token:${{ secrets.GH_PUSH_TOKEN }}@github.com/${{ github.repository }}.git
            git push origin HEAD:${{ github.ref_name }}
          fi
      - name: Upload latest snapshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: latest-run
          path: data/latest_run.json
          if-no-files-found: ignore
